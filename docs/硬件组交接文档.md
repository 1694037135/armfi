# 🔧 硬件组交接文档

> **面向对象**：硬件组成员
> **目的**：快速上手系统调试和测试
> **更新时间**：2026-01-29

---

## 📋 快速导航

- [系统已完成功能](#系统已完成功能)
- [你需要做什么](#你需要做什么)
- [快速开始](#快速开始)
- [常见问题](#常见问题)

---

## ✅ 系统已完成功能

软件组已经完成以下功能，**你可以直接使用**：

### 1. 完整的控制系统
- ✅ 3D 可视化界面（浏览器访问）
- ✅ 键盘控制（WASD + QE）
- ✅ 串口通信（支持角度回传）
- ✅ 逆运动学自动规划
- ✅ 模拟/实物模式切换

### 2. AI 视觉功能
- ✅ YOLO 物体检测
- ✅ 摄像头标定（点击抓取）
- ✅ ArUco 标记自动识别

### 3. 大模型对话
- ✅ 自然语言控制
- ✅ 语音识别
- ✅ 预定义动作库

### 4. 调试工具
- ✅ 串口监视器
- ✅ 标定助手
- ✅ 硬件测试套件
- ✅ ArUco 标记生成器

---

## 🎯 你需要做什么

### 主要任务

1. **连接硬件**
   - 将机械臂 USB 线连接到电脑
   - 确认串口号（Windows: COM3，Linux: /dev/ttyUSB0）

2. **配置串口**
   - 编辑 `ai-service/config.json`
   - 设置 `SERIAL_ENABLED: true`
   - 设置 `SERIAL_PORT: "COM3"`（根据实际调整）

3. **适配串口协议**（如果需要）
   - 查看你的硬件串口协议文档
   - 修改 `ai-service/serial_transport.py`
   - 适配 `read_status()` 和 `send_command()` 方法

4. **摄像头标定**
   - 打印 ArUco 标记
   - 固定摄像头位置
   - 运行标定助手完成标定

5. **测试验证**
   - 运行硬件测试套件
   - 验证各项功能正常

### 预计时间

- **首次调试**：3-5 天
- **熟悉后**：1-2 天

---

## 🚀 快速开始

### 步骤 1：启动系统（2 分钟）

```bash
# Windows
cd robot-control-system
deploy.bat

# Linux/Mac
cd robot-control-system
./deploy.sh
```

访问：http://localhost

### 步骤 2：测试模拟模式（5 分钟）

1. 打开浏览器 http://localhost
2. 默认是"模拟"模式
3. 按键盘 WASD 控制机械臂
4. 观察 3D 模型是否正常移动

**如果模拟模式正常，说明软件系统没问题！**


### 步骤 3：连接硬件（10 分钟）

#### 3.1 确认串口号

**Windows**：
```powershell
# 方式 1：设备管理器
devmgmt.msc
# 查看 "端口(COM 和 LPT)"，找到类似 "USB-SERIAL CH340 (COM3)"

# 方式 2：PowerShell
[System.IO.Ports.SerialPort]::getportnames()
```

**Linux**：
```bash
ls /dev/ttyUSB* /dev/ttyACM*
# 输出：/dev/ttyUSB0
```

#### 3.2 配置串口

编辑 `robot-control-system/ai-service/config.json`：

```json
{
  "SERIAL_ENABLED": true,
  "SERIAL_PORT": "COM3",           // Windows
  // "SERIAL_PORT": "/dev/ttyUSB0", // Linux
  "SERIAL_BAUDRATE": 115200,
  
  "CAMERA_ENABLED": false,   // 先不启用摄像头
  "GEMINI_API_KEY": "your-key-here"
}
```

#### 3.3 重启服务

```bash
docker-compose restart ai-service
```

### 步骤 4：测试串口通信（15 分钟）

#### 4.1 使用串口监视器

```bash
# Windows
debug-tools.bat
# 选择 [1] 串口监视器

# Linux/Mac
./debug-tools.sh
# 选择 [1] 串口监视器
```

或直接运行：
```bash
python tools/serial_monitor.py --port COM3 --baudrate 115200
```

#### 4.2 观察数据

**正常情况**：
```
┌─ 📥 接收 (RX) ────────────────────────┐
│ [18:30:15.123] 0,30,45,60,0,90       │
│ [18:30:15.223] 0,30,45,60,0,90       │
└───────────────────────────────────────┘
```

**如果没有数据**：
- 检查串口号是否正确
- 检查波特率是否匹配
- 检查硬件是否上电

### 步骤 5：切换到实物模式（5 分钟）

1. 打开浏览器 http://localhost
2. 点击右上角 **"实物"** 按钮
3. 观察角度显示是否实时更新
4. 按键盘控制，观察机械臂是否移动

**验证成功标志**：
- ✅ 前端显示的角度与实际一致
- ✅ 键盘控制机械臂能正常移动
- ✅ 手动移动机械臂，前端角度跟随变化

---

## 🛠️ 串口协议适配（如果需要）

### 什么时候需要适配？

如果你的硬件串口协议与默认不同，需要修改代码。

### 如何适配？

#### 1. 查看你的硬件协议

使用串口监视器观察数据格式：

```
# 格式 1：CSV
0,30,45,60,0,90

# 格式 2：JSON
{"angles":[0,30,45,60,0,90]}

# 格式 3：自定义
A:0,30,45,60,0,90;E:0
```

#### 2. 修改 `serial_transport.py`

文件位置：`robot-control-system/ai-service/serial_transport.py`

**示例：适配 CSV 格式**

```python
def read_status(self):
    """读取机械臂当前状态"""
    if not self.connected:
        return self._mock_status()
    
    try:
        # 发送查询指令（根据你的硬件修改）
        self.ser.write(b"GET_ANGLES\r\n")
        
        # 读取返回
        line = self.ser.readline().decode('utf-8').strip()
        
        if not line:
            return self._mock_status()
        
        # 解析 CSV: "0,30,45,60,0,90"
        angles_deg = [float(x) for x in line.split(',')]
        
        if len(angles_deg) != 6:
            raise ValueError(f"Expected 6 angles, got {len(angles_deg)}")
        
        return {
            "angles_deg": angles_deg,
            "angles_rad": [deg * 3.14159 / 180 for deg in angles_deg],
            "error_code": 0,
            "serial_mock": False
        }
    
    except Exception as e:
        print(f"Serial read error: {e}")
        return self._mock_status()
```

**示例：适配 JSON 格式**

```python
def read_status(self):
    """读取机械臂当前状态"""
    if not self.connected:
        return self._mock_status()
    
    try:
        # 发送查询指令
        self.ser.write(b'{"action":"get_status"}\r\n')
        
        # 读取返回
        line = self.ser.readline().decode('utf-8').strip()
        
        if not line:
            return self._mock_status()
        
        # 解析 JSON
        import json
        data = json.loads(line)
        angles_deg = data.get("angles", [0]*6)
        
        return {
            "angles_deg": angles_deg,
            "angles_rad": [deg * 3.14159 / 180 for deg in angles_deg],
            "error_code": data.get("error", 0),
            "serial_mock": False
        }
    
    except Exception as e:
        print(f"Serial read error: {e}")
        return self._mock_status()
```

#### 3. 测试修改

```bash
cd robot-control-system/ai-service
python test_serial.py
```

**预期输出**：
```
=== 串口测试开始 ===

Test 1: 读取角度
  [1] angles_deg: [0, 30, 45, 60, 0, 90]
      mock: False  ← 这里应该是 False
  [2] angles_deg: [0, 30, 45, 60, 0, 90]
      mock: False

Test 2: 发送指令
  发送结果: 成功

=== 测试完成 ===
```

---

## 📷 摄像头标定（可选）

### 什么时候需要？

如果你要使用"点击抓取"功能，需要标定摄像头。

### 快速标定流程

#### 1. 生成 ArUco 标记

```bash
python tools/generate_aruco_marker.py --sheet --ids 0 1 2 3 4 5 6 7 8 9 10 11
```

打印 `aruco_sheet_4x4_50.png`（A4 纸）

#### 2. 摆放标记

```
┌─────────────────────────────────────────────┐
│                                             │
│   [ArUco #0]           [ArUco #1]          │  ← 后方
│    (左后)               (右后)              │
│                                             │
│              🤖 机械臂                       │
│                                             │
│   [ArUco #2]           [ArUco #3]          │  ← 前方
│    (左前)               (右前)              │
│                                             │
└─────────────────────────────────────────────┘
```

#### 3. 运行标定助手

```bash
python tools/camera_calibration_helper.py
```

按 `a` 启用 ArUco 检测，按 `空格` 添加标定点。

#### 4. 验证精度

随机点击位置，误差应 < 10mm。

---

## ❓ 常见问题

### Q1：串口连接失败

**错误**：`SerialException: Could not open port COM3`

**解决**：
1. 确认串口号正确（设备管理器）
2. 关闭其他串口工具（Arduino IDE）
3. 检查驱动是否安装（CH340/CP2102）
4. Linux 权限：`sudo chmod 666 /dev/ttyUSB0`

### Q2：角度不更新

**症状**：前端一直显示 `[0, 0, 0, 0, 0, 0]`

**解决**：
1. 检查 `config.json` 中 `SERIAL_ENABLED: true`
2. 查看日志：`docker-compose logs -f ai-service`
3. 确认 `serial_mock` 是 `false`
4. 运行 `python test_serial.py` 测试

### Q3：机械臂不动

**症状**：前端发送指令，机械臂没反应

**解决**：
1. 检查 `send_command()` 指令格式
2. 用串口监视器手动发送指令验证
3. 检查硬件是否上电
4. 检查舵机是否锁定

### Q4：标定精度差

**症状**：点击位置与实际偏差 > 10mm

**解决**：
1. 增加标定点数量（6-8 个）
2. 确保标记分布均匀
3. 固定摄像头位置（不能移动）
4. 使用 ArUco 自动检测（更精确）

---

## 📞 获取帮助

### 文档资源

- 📘 **详细调试指南**：`docs/硬件调试教程.md`（5 天完整流程）
- 📊 **项目进度报告**：`docs/PROJECT_STATUS.md`
- 🚀 **部署指南**：`docs/本地部署指南.md`

### 联系方式

- **GitHub Issues**：报告 Bug
- **GitHub Discussions**：技术讨论
- **软件组成员**：直接沟通

---

## ✅ 交接检查清单

在开始调试前，确认以下事项：

- [ ] 系统已成功启动（`docker-compose ps` 显示 3 个服务运行中）
- [ ] 模拟模式测试通过（3D 模型正常控制）
- [ ] 串口号已确认
- [ ] `config.json` 已配置
- [ ] 调试工具已安装（`pip install -r tools/requirements.txt`）
- [ ] ArUco 标记已打印（如需标定）
- [ ] 已阅读 `docs/硬件调试教程.md`

---

## 🎯 预期成果

完成调试后，你应该实现：

✅ 实时角度回传（10Hz 刷新）
✅ 双向控制（手动 + 程序控制）
✅ 摄像头视觉定位（<10mm 精度）
✅ 语音/LLM 智能控制
✅ 完整的监控界面

**祝调试顺利！** 🎉

---

**文档版本**：v1.0
**最后更新**：2026-01-29
